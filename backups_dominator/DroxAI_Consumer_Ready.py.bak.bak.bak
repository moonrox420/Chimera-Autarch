#!/usr/bin/env python3
"""
DroxAI Consumer - Single Double-Click Launcher
Handles all complexity behind the scenes
"""
import subprocess
import sys
import os
import webbrowser
import time
import threading
from pathlib import Path

def check_and_install_requirements():
    """Check and install required Python modules with better error handling"""
    print("üîç Checking system requirements...")
    
    # Check Python version
    if sys.version_info < (3, 8):
        print("‚ùå Python 3.8+ required. Please upgrade Python.")
        input("Press Enter to exit...")
        return False
    
    print(f"‚úÖ Python {sys.version.split()[0]} detected")
    
    # Check required modules with comprehensive error handling
    required_modules = ['websockets', 'aiohttp', 'numpy']
    missing_modules = []
    
    for module in required_modules:
        try:
            __import__(module)
            print(f"‚úÖ {module} available")
        except Exception as e:
            missing_modules.append(module)
            print(f"‚ùå {module} missing ({str(e)})")
    
    if missing_modules:
        print(f"\nüì¶ Installing missing modules: {', '.join(missing_modules)}")
        try:
            # Try installing with pip
            subprocess.check_call([sys.executable, "-m", "pip", "install"] + missing_modules)
            print("‚úÖ Modules installed successfully")
            
            # Verify installation worked
            for module in missing_modules:
                try:
                    __import__(module)
                    print(f"‚úÖ {module} verified installed")
                except Exception:
                    print(f"‚ö†Ô∏è  {module} installation may have failed")
        except subprocess.CalledProcessError as e:
            print("‚ùå Failed to install required modules automatically")
            print(f"Error: {e}")
            print("\nüîß Manual installation required:")
            print("Please run: pip install websockets aiohttp numpy")
            print("\nAlternatively, try installing them one by one:")
            for module in missing_modules:
                print(f"  pip install {module}")
            input("\nPress Enter to exit...")
            return False
    
    return True

def start_droxai():
    """Start DroxAI system with consumer-friendly error handling"""
    print("\nüöÄ Starting DroxAI...")
    
    try:
        # Start the main CHIMERA system
        chimera_process = subprocess.Popen([
            sys.executable, "chimera_autarch.py"
        ], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        
        print("‚úÖ CHIMERA system started")
        
        # Wait for system to initialize
        print("‚è≥ Waiting for system to initialize...")
        time.sleep(5)
        
        # Check if process is still running
        if chimera_process.poll() is not None:
            stdout, stderr = chimera_process.communicate()
            print("‚ùå CHIMERA system failed to start")
            if stderr:
                print(f"Error: {stderr.decode()}")
            if stdout:
                print(f"Output: {stdout.decode()}")
            return False
        
        # Open web interface
        print("üåê Opening web interface...")
        try:
            webbrowser.open("http://localhost: 3001")
        except Exception as e:
            print(f"‚ö†Ô∏è  Could not open browser automatically: {e}")
            print("   Please manually open http://localhost: 3001 in your browser")
        
        print("\n" + "="*60)
        print("üéâ DroxAI is now running!")
        print("="*60)
        print("üìä Web Dashboard: http://localhost: 3001")
        print("üîå WebSocket API: ws://localhost: 3001")
        print("\n‚ö†Ô∏è  Keep this window open to keep DroxAI running")
        print("üî¥ Close this window or press Ctrl+C to stop")
        print("="*60)
        
        # Monitor process with user feedback
        try:
            chimera_process.wait()
        except KeyboardInterrupt:
            print("\nüõë Shutting down DroxAI...")
            chimera_process.terminate()
            chimera_process.wait()
            print("‚úÖ DroxAI stopped gracefully")
        
        return True
        
    except FileNotFoundError:
        print("‚ùå Could not find chimera_autarch.py")
        print("Please make sure all files are in the same folder")
        input("Press Enter to exit...")
        return False
    except Exception as e:
        print(f"‚ùå Failed to start DroxAI: {e}")
        print("\nüîß Troubleshooting:")
        print("1. Make sure all files are in the same folder")
        print("2. Check that Python 3.8+ is installed")
        print("3. Verify no antivirus is blocking the application")
        print("4. Try running as administrator on Windows")
        input("\nPress Enter to exit...")
        return False

def main():
    """Main consumer entry point"""
    print("=" * 60)
    print("    üöÄ DroxAI - Advanced AI Orchestration System")
    print("    Consumer Edition v1.0.0")
    print("=" * 60)
    print()
    
    # Change to script directory
    script_dir = Path(__file__).parent
    os.chdir(script_dir)
    
    # Check requirements and install if needed
    if not check_and_install_requirements():
        return
    
    # Start DroxAI
    start_droxai()

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nüëã Goodbye!")
    except Exception as e:
        print(f"‚ùå Unexpected error: {e}")
        print("Please contact support with this error message.")
        input("Press Enter to exit...")
