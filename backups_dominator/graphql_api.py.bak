"""
GraphQL API resolver for CHIMERA AUTARCH
Provides GraphQL interface for system introspection and control
"""

import json
from typing import Dict, Any, List, Optional
from dataclasses import dataclass, asdict
import logging

logger = logging.getLogger(__name__)

@dataclass
class NodeInfo:
    id: str
    type: str
    resources: Dict[str, Any]
    capabilities: List[str]
    reputation: float
    last_heartbeat: float

@dataclass
class ToolInfo:
    name: str
    version: str
    description: str
    success_rate: float
    avg_latency: float

class GraphQLResolver:
    """GraphQL resolver for CHIMERA AUTARCH system introspection"""
    
    def __init__(self, heart_node):
        self.heart_node = heart_node
        
    async def resolve(self, query: str, variables: Dict[str, Any] = None) -> Dict[str, Any]:
        """
        Resolve a GraphQL query against the CHIMERA system state
        
        Args:
            query: The GraphQL query string
            variables: Query variables (unused currently)
            
        Returns:
            GraphQL response with data and/or errors
        """
        try:
            # Simple query parsing for now - expand as needed
            query_lower = query.lower()
            
            # System status query
            if "system" in query_lower and "status" in query_lower:
                return self._get_system_status()
            
            # Nodes query
            elif "nodes" in query_lower:
                return self._get_nodes()
            
            # Tools query
            elif "tools" in query_lower:
                return self._get_tools()
            
            # Intents query (for learning patterns)
            elif "intents" in query_lower:
                return self._get_intents()
            
            # General introspection
            elif "introspection" in query_lower:
                return self._get_schema()
            
            # Default: provide basic system info
            else:
                return self._get_basic_info()
                
        except Exception as e:
            logger.error(f"GraphQL resolution error: {e}")
            return {"errors": [{"message": str(e)}]}
    
    def _get_system_status(self) -> Dict[str, Any]:
        """Get overall system status"""
        return {
            "data": {
                "systemStatus": {
                    "status": "operational",
                    "uptime": 3000,  # Would track real uptime
                    "totalNodes": len(self.heart_node.nodes),
                    "activeTools": len(self.heart_node.registry.tools),
                    "memoryUsage": "stable",
                    "lastActivity": 300090.0
                }
            }
        }
    
    def _get_nodes(self) -> Dict[str, Any]:
        """Get all registered nodes"""
        nodes_data = []
        for node_id, node_info in self.heart_node.nodes.items():
            nodes_data.append({
                "id": node_id,
                "type": node_info.type,
                "capabilities": node_info.capabilities,
                "reputation": node_info.reputation,
                "lastHeartbeat": node_info.last_heartbeat,
                "resources": node_info.resources
            })
        
        return {"data": {"nodes": nodes_data}}
    
    def _get_tools(self) -> Dict[str, Any]:
        """Get all registered tools with metrics"""
        tools_data = []
        for tool_name, tool in self.heart_node.registry.tools.items():
            stats = self.heart_node.registry.stats(tool_name)
            tools_data.append({
                "name": tool_name,
                "version": tool.version,
                "description": tool.description,
                "successRate": stats["success_rate"],
                "avgLatency": stats["avg_latency"]
            })
        
        return {"data": {"tools": tools_data}}
    
    def _get_intents(self) -> Dict[str, Any]:
        """Get intent learning patterns"""
        intents_data = []
        for pattern_topic, pattern in self.heart_node.metacog.patterns.items():
            intents_data.append({
                "topic": pattern_topic,
                "failureCount": pattern.count,
                "confidence": pattern.confidence,
                "firstSeen": pattern.first_seen,
                "lastSeen": pattern.last_seen,
                "successHistory": list(pattern.success_history)
            })
        
        return {"data": {"intents": intents_data}}
    
    def _get_schema(self) -> Dict[str, Any]:
        """Return GraphQL schema information"""
        return {
            "data": {
                "schema": {
                    "types": [
                        {"name": "SystemStatus", "fields": ["status", "uptime", "totalNodes"]},
                        {"name": "Node", "fields": ["id", "type", "capabilities", "reputation"]},
                        {"name": "Tool", "fields": ["name", "version", "description", "successRate"]},
                        {"name": "Intent", "fields": ["topic", "failureCount", "confidence"]}
                    ]
                }
            }
        }
    
    def _get_basic_info(self) -> Dict[str, Any]:
        """Basic system information"""
        return {
            "data": {
                "info": {
                    "version": "3.0.0",
                    "service": "CHIMERA AUTARCH",
                    "nodes": len(self.heart_node.nodes),
                    "tools": len(self.heart_node.registry.tools),
                    "patterns": len(self.heart_node.metacog.patterns)
                }
            }
        }
