# üöÄ DroxAI Tower + CHIMERA Integration Guide

**Connect your DroxAI Tower API key system with CHIMERA AUTARCH**

## Overview

This integration connects:
- **DroxAI Tower** (port 8001) - Your API key generation and threat intelligence system
- **Enterprise AI** (port 3000) - Local AI models (CodeLlama, Llama2 Uncensored)
- **CHIMERA AUTARCH** (ports 3001/3000) - Self-evolving AI orchestration system

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ DroxAI Tower    ‚îÇ  Port 8001
‚îÇ API Keys        ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Threat Intel    ‚îÇ        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
                           ‚îÇ Validates keys
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ Enterprise AI   ‚îÇ  Port 3000
‚îÇ CodeLlama 7B    ‚îÇ        ‚îÇ
‚îÇ Llama2 Uncensored‚îÇ       ‚îú‚îÄ‚îÄ‚Üí ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ    ‚îÇ CHIMERA AUTARCH  ‚îÇ
                           ‚îÇ    ‚îÇ WebSocket: 3001  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ    ‚îÇ HTTP: 3000       ‚îÇ
‚îÇ User/Client     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ Tower Adapter    ‚îÇ
‚îÇ DroxAI API Key  ‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Quick Start

### 1. Install Dependencies

```bash
# Activate CHIMERA environment
source droxai-env/bin/activate  # Linux/macOS
.\droxai-env\Scripts\Activate.ps1  # Windows

# Install DroxAI Tower dependencies
pip install httpx fastapi uvicorn[standard] aiosqlite pydantic
```

### 2. Start DroxAI Tower

```bash
# Save your DroxAI Tower code as droxai_tower.py
python droxai_tower.py --port 8001
```

Expected output:
```
üöÄ droxaitower - Enterprise AI Edition v2.0.0-enterprise
============================================================
üéØ Features:
  ‚Ä¢ Local CodeLlama 7B (4096 tokens)
  ‚Ä¢ Uncensored Llama2 7B chat
  ‚Ä¢ Intelligent model routing
  ‚Ä¢ Zero API costs
  ‚Ä¢ Complete privacy
  ‚Ä¢ Usage analytics

üåê DroxAI Tower starting on port 8001...
üìç UI: http://localhost:8001
ü§ñ Enterprise AI: http://localhost:3000
```

### 3. Configure CHIMERA

```bash
# Set DroxAI Tower connection details
export DROXAI_TOWER_URL="http://localhost:8001"
export DROXAI_TOWER_API_KEY="your_droxai_admin_key"
export DROXAI_TOWER_SECRET="your_tower_secret"
```

### 4. Integrate with CHIMERA

Add to `chimera_autarch.py`:

```python
# At top of file
from droxai_tower_adapter import DroxAITowerAdapter, integrate_droxai_tower_with_chimera

class HeartNode:
    def __init__(self, ...):
        # ... existing init ...
        
        # Add DroxAI Tower integration
        self.droxai_tower = None
    
    async def _init_droxai_tower(self):
        """Initialize DroxAI Tower integration"""
        try:
            self.droxai_tower = await integrate_droxai_tower_with_chimera(
                security_manager=self.security
            )
            
            health = await self.droxai_tower.health_check()
            logger.info(f"[DROXAI] Tower: {health['droxai_tower']['status']}")
            logger.info(f"[DROXAI] Enterprise AI: {health['enterprise_ai']['status']}")
            
            # Get available models
            models = await self.droxai_tower.get_available_models()
            logger.info(f"[DROXAI] Available models: {len(models)}")
            
        except Exception as e:
            logger.warning(f"[DROXAI] Integration failed: {e}")
    
    async def _handle_websocket_client(self, websocket, path):
        """Handle WebSocket client with DroxAI key auth"""
        try:
            # First message should be authentication
            auth_msg = await asyncio.wait_for(websocket.recv(), timeout=10.0)
            auth_data = json.loads(auth_msg)
            
            # Support DroxAI API key authentication
            if auth_data.get("type") == "auth_droxai":
                api_key = auth_data.get("api_key")
                
                if self.droxai_tower:
                    jwt_token = await self.droxai_tower.authenticate_with_tower(api_key)
                    
                    if jwt_token:
                        await websocket.send(json.dumps({
                            "type": "auth_success",
                            "user_id": jwt_token.user_id,
                            "role": jwt_token.role.value,
                            "capabilities": list(jwt_token.capabilities)
                        }))
                        
                        # Continue with authenticated connection
                        # ... existing websocket handler code ...
                    else:
                        await websocket.send(json.dumps({
                            "type": "error",
                            "message": "Invalid DroxAI API key"
                        }))
                        return
                else:
                    await websocket.send(json.dumps({
                        "type": "error",
                        "message": "DroxAI Tower not available"
                    }))
                    return
            
            # ... rest of existing auth logic ...
            
        except Exception as e:
            logger.error(f"[DROXAI] Auth error: {e}")
```

Call initialization in `__main__`:

```python
if __name__ == "__main__":
    node = HeartNode()
    
    # Initialize DroxAI Tower integration
    asyncio.run(node._init_droxai_tower())
    
    # ... rest of startup ...
```

## Usage Examples

### Example 1: Authenticate with DroxAI Key

```python
from droxai_tower_adapter import DroxAITowerAdapter
from security import SecurityManager

# Initialize
security = SecurityManager()
droxai = DroxAITowerAdapter(
    tower_url="http://localhost:8001",
    tower_api_key="your_admin_key",
    security_manager=security
)

# Authenticate with DroxAI key
api_key = "droxai_key_abc123..."
jwt_token = await droxai.authenticate_with_tower(api_key)

if jwt_token:
    logging.info(f"‚úÖ Authenticated: {jwt_token.user_id}")
    logging.info(f"   Role: {jwt_token.role.value}")
    logging.info(f"   Capabilities: {jwt_token.capabilities}")
```

### Example 2: WebSocket Client with DroxAI Key

```javascript
// JavaScript client
const ws = new WebSocket('ws://localhost:3001');

ws.onopen = () => {
    // Authenticate with DroxAI API key
    ws.send(JSON.stringify({
        type: 'auth_droxai',
        api_key: 'droxai_key_abc123...'
    }));
};

ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    
    if (msg.type === 'auth_success') {
        console.log('‚úÖ Authenticated!');
        console.log('User:', msg.user_id);
        console.log('Role:', msg.role);
        
        // Send intent
        ws.send(JSON.stringify({
            type: 'intent',
            intent: 'show system stats'
        }));
    }
};
```

### Example 3: Get Usage Stats from DroxAI Tower

```python
# Get usage statistics for a key
stats = await droxai.get_tower_usage_stats("droxai_key_id")

logging.info(f"Total requests: {stats['overall']['total_requests']}")
logging.info(f"Total tokens: {stats['overall']['total_tokens']}")
logging.info(f"Total cost: ${stats['overall']['total_cost']}")  # Should be $0!
logging.info(f"Enterprise AI savings: ${stats['enterprise_ai_savings']}")

# Usage by model
for model in stats['by_model']:
    logging.info(f"{model['model']}: {model['requests']} requests, {model['tokens']} tokens")
```

### Example 4: Check Available Models

```python
# Get Enterprise AI models from DroxAI Tower
models = await droxai.get_available_models()

for model in models:
    logging.info(f"Model: {model['id']}")
    logging.info(f"  Type: {model.get('type', 'unknown')}")
    logging.info(f"  Context: {model.get('max_tokens', 0)} tokens")
    logging.info(f"  Cost: ${model.get('pricing', {}).get('input', 0)} / 1K")
    logging.info(f"  Enterprise AI: {model.get('enterprise_ai', False)}")
```

## DroxAI Scope ‚Üí CHIMERA Capability Mapping

| DroxAI Scope | CHIMERA Capability | Description |
|--------------|-------------------|-------------|
| `admin:full` | `*` | Full admin access |
| `master:*` | `*` | Full admin access |
| `models:codellama` | `execute:code_generation`<br>`execute:analyze_and_suggest_patch` | Code completion tools |
| `models:chat` | `execute:chat`<br>`execute:echo` | Chat tools |
| `models:*` | `execute:*` | All model access |
| `api:read` | `execute:get_system_stats`<br>`execute:read_file` | Read-only API access |
| `api:write` | `execute:write_file` | Write API access |
| `api:access` | `execute:get_system_stats`<br>`execute:echo` | Basic API access |
| `tools:execute` | `execute:*` | Execute all tools |
| `tools:view` | `execute:get_system_stats` | View-only tools |
| `system:manage` | `*` | System management |
| `system:view` | `execute:get_system_stats`<br>`execute:get_node_status` | View system stats |

## DroxAI Role ‚Üí CHIMERA Role Mapping

| DroxAI Role | CHIMERA Role | Permissions |
|-------------|--------------|-------------|
| `admin` | `ADMIN` | Full access |
| `master` | `ADMIN` | Full access |
| `operator` | `OPERATOR` | Execute, view, trigger |
| `user` | `OPERATOR` | Execute, view, trigger |
| `observer` | `OBSERVER` | View-only |
| `readonly` | `OBSERVER` | View-only |
| `api_client` | `API_CLIENT` | External API access |
| `service` | `API_CLIENT` | External API access |
| `node` | `NODE` | Node operations |

## Health Monitoring

```python
# Check integration health
health = await droxai.health_check()

logging.info(f"Overall Status: {health['status']}")
logging.info(f"\nDroxAI Tower:")
logging.info(f"  Status: {health['droxai_tower']['status']}")
logging.info(f"  URL: {health['droxai_tower']['url']}")

logging.info(f"\nEnterprise AI:")
logging.info(f"  Status: {health['enterprise_ai']['status']}")
logging.info(f"  URL: {health['enterprise_ai']['url']}")
logging.info(f"  Ollama: {health['enterprise_ai']['ollama_status']}")
logging.info(f"  Models: {len(health['enterprise_ai']['models_available'])}")
```

## Testing

```bash
# Test DroxAI Tower adapter
python droxai_tower_adapter.py
```

Expected output:
```
============================================================
CHIMERA ‚Üî DroxAI Tower Integration Test
============================================================
üîó Connecting to DroxAI Tower...

üìä Health Check:
   Status: healthy
   DroxAI Tower: up
   Enterprise AI: up

ü§ñ Available Models: 3
   ‚Ä¢ codellama:7b-code (code-completion)
   ‚Ä¢ llama2-uncensored:7b (chat)
   ‚Ä¢ enterprise-ai-auto (auto-route)

üîë Creating test DroxAI key...
   Key: tower_abc123...

üîê Authenticating...
   ‚úÖ Authenticated!
   User: test_user
   Role: operator
   Capabilities: 8

üõ°Ô∏è Permission Check:
   ‚úÖ Can execute tools
   ‚úÖ Can view metrics

üìà Cache Stats:
   Cached keys: 1
   Valid keys: 1
   Hit ratio: 100.00%
```

## Troubleshooting

### Issue: "DroxAI Tower connection timeout"
**Solution**: 
- Ensure DroxAI Tower is running on port 8001
- Check firewall settings
- Verify `DROXAI_TOWER_URL` environment variable

### Issue: "Enterprise AI not available"
**Solution**:
- Start Enterprise AI on port 3000
- Verify Ollama is running: `ollama list`
- Pull required models: `ollama pull codellama:7b-code`

### Issue: "Invalid DroxAI API key"
**Solution**:
- Check API key format
- Verify key exists in DroxAI Tower database
- Check key hasn't expired

### Issue: "httpx not installed"
**Solution**:
```bash
pip install httpx
```

## Security Considerations

1. **API Key Storage**: DroxAI keys are cached for 5 minutes (configurable via `cache_ttl`)
2. **Rate Limiting**: Respects DroxAI Tower's rate limits in key metadata
3. **Audit Logging**: All authentication attempts logged by CHIMERA
4. **Token Expiry**: JWT tokens inherit DroxAI key expiry
5. **Capability Isolation**: DroxAI scopes strictly mapped to CHIMERA capabilities

## Performance

- **First auth with DroxAI key**: ~50-200ms (Tower API call)
- **Cached auth**: <1ms (cache lookup)
- **JWT creation**: ~2ms
- **Cache hit ratio**: Typically >90% with 5min TTL
- **Enterprise AI models**: Local, 0 latency to external APIs

## Complete Example

```python
import asyncio
from security import SecurityManager
from droxai_tower_adapter import integrate_droxai_tower_with_chimera

async def main():
    # Initialize CHIMERA security
    security = SecurityManager()
    
    # Integrate DroxAI Tower
    droxai = await integrate_droxai_tower_with_chimera(security)
    
    # Health check
    health = await droxai.health_check()
    logging.info(f"System Status: {health['status']}")
    
    # Create test key
    test_key = droxai.create_tower_key_locally(
        user_id="developer_alice",
        role="operator",
        scopes={
            "api:access",
            "models:codellama",
            "models:chat",
            "tools:execute"
        },
        expires_in_days=30,
        metadata={
            "team": "backend",
            "enterprise_ai_access": True,
            "rate_limit": 200
        }
    )
    
    # Authenticate
    jwt = await droxai.authenticate_with_tower(test_key)
    
    if jwt:
        logging.info(f"‚úÖ Authenticated: {jwt.user_id}")
        
        # Use CHIMERA tools with DroxAI authentication
        # ... your CHIMERA code here ...
    
    # Get usage stats
    stats = await droxai.get_tower_usage_stats(jwt.user_id)
    logging.info(f"Total cost: ${stats['overall']['total_cost']}")  # $0!

if __name__ == "__main__":
    asyncio.run(main())
```

---

**Questions?** Check `droxai_tower_adapter.py` for implementation details or run the test suite.
