# CHIMERA NEXUS - Windows Installation Quick Fix
# Run this if regular install fails

Write-Host "üîß CHIMERA NEXUS - Quick Fix Installer for Windows" -ForegroundColor Cyan
Write-Host "===================================================" -ForegroundColor Cyan
Write-Host ""

# Activate environment
if (Test-Path "droxai-env\Scripts\Activate.ps1") {
  & .\droxai-env\Scripts\Activate.ps1
}
else {
  Write-Host "Creating virtual environment..." -ForegroundColor Yellow
  python -m venv droxai-env
  & .\droxai-env\Scripts\Activate.ps1
}

Write-Host "üì• Installing packages with pre-built wheels only..." -ForegroundColor Yellow
Write-Host ""

# Core packages (always work)
Write-Host "[1/5] Core dependencies..." -ForegroundColor Cyan
python -m pip install --upgrade pip
pip install websockets aiosqlite numpy pyyaml pycryptodome psutil httpx watchdog PyJWT

# ML packages - specific versions that have Windows wheels
Write-Host ""
Write-Host "[2/5] Machine Learning (TensorFlow + scikit-learn)..." -ForegroundColor Cyan
Write-Host "This will take 2-5 minutes..." -ForegroundColor Gray

# TensorFlow 2.16.1 is last stable version with good Windows support
pip install "tensorflow==2.16.1"

# scikit-learn 1.4.0 is last version with reliable Windows wheels
pip install "scikit-learn==1.4.0"

# Federated learning - Let flwr manage its own grpcio version
Write-Host ""
Write-Host "[3/5] Federated Learning (Flower)..." -ForegroundColor Cyan
pip install "flwr==1.23.0"

# Cloud SDKs - only AWS by default
Write-Host ""
Write-Host "[4/5] Cloud SDK (AWS only)..." -ForegroundColor Cyan
pip install boto3

# Voice processing
Write-Host ""
Write-Host "[5/5] Voice Processing (Whisper + TTS)..." -ForegroundColor Cyan
pip install openai-whisper pyttsx3 sounddevice

Write-Host ""
Write-Host "‚úÖ Installation complete!" -ForegroundColor Green
Write-Host ""

# Test imports
Write-Host "üß™ Testing critical imports..." -ForegroundColor Cyan

$tests = @(
  @("TensorFlow", "import tensorflow as tf; logging.info(f'TensorFlow {tf.__version__}')"),
  @("scikit-learn", "import sklearn; logging.info(f'scikit-learn {sklearn.__version__}')"),
  @("NumPy", "import numpy; logging.info(f'NumPy {numpy.__version__}')"),
  @("Whisper", "import whisper; logging.info('Whisper OK')"),
  @("boto3", "import boto3; logging.info(f'boto3 {boto3.__version__}')"),
  @("Flower", "import flwr; logging.info('Flower OK')")
)

$passed = 0
foreach ($test in $tests) {
  Write-Host "  Testing $($test[0])..." -NoNewline
  $result = python -c $test[1] 2>&1
  if ($LASTEXITCODE -eq 0) {
    Write-Host " ‚úÖ" -ForegroundColor Green
    $passed++
  }
  else {
    Write-Host " ‚ùå" -ForegroundColor Red
  }
}

Write-Host ""
if ($passed -eq $tests.Count) {
  Write-Host "üéâ All packages working! Ready to start CHIMERA." -ForegroundColor Green
  Write-Host ""
  Write-Host "Next steps:" -ForegroundColor Cyan
  Write-Host "  .\start_nexus.ps1" -ForegroundColor White
}
else {
  Write-Host "‚ö†Ô∏è  Some packages failed. Try:" -ForegroundColor Yellow
  Write-Host "  pip install --force-reinstall <package-name>" -ForegroundColor Gray
}

Write-Host ""
Write-Host "üìù Note: For voice control, download PyAudio wheel from:" -ForegroundColor Cyan
Write-Host "   https://www.lfd.uci.edu/~gohlke/pythonlibs/#pyaudio" -ForegroundColor White
