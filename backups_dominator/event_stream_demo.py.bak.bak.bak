#!/usr/bin/env python3
"""
Event Stream Demo - Real-time event monitoring for CHIMERA AUTARCH
Connects to CHIMERA and displays live events as they occur
"""
import asyncio
import websockets
import json
import argparse
from datetime import datetime
from typing import Optional

# ANSI color codes for pretty terminal output


class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKCYAN = '\033[96m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'


class EventStreamClient:
    """WebSocket client for subscribing to CHIMERA events"""

    def __init__(self, host: str = "localhost", port: int = 3001, use_ssl: bool = False):
        protocol = "wss" if use_ssl else "ws"
        self.uri = f"{protocol}://{host}:{port}"
        self.client_id = f"monitor_{int(datetime.now().timestamp())}"
        self.websocket: Optional[websockets.WebSocketClientProtocol] = None

        # Event type display configurations
        self.event_colors = {
            "evolution_applied": Colors.OKGREEN,
            "node_registered": Colors.OKCYAN,
            "node_disconnected": Colors.WARNING,
            "tool_executed": Colors.OKBLUE,
            "confidence_changed": Colors.WARNING,
            "learning_started": Colors.HEADER,
            "learning_completed": Colors.OKGREEN,
            "task_dispatched": Colors.OKBLUE,
            "task_completed": Colors.OKGREEN,
            "system_alert": Colors.FAIL
        }

        self.event_icons = {
            "evolution_applied": "ðŸ§¬",
            "node_registered": "ðŸ“¡",
            "node_disconnected": "âŒ",
            "tool_executed": "âš™ï¸",
            "confidence_changed": "ðŸ“Š",
            "learning_started": "ðŸŽ“",
            "learning_completed": "âœ…",
            "task_dispatched": "ðŸ“¤",
            "task_completed": "âœ…",
            "system_alert": "ðŸš¨"
        }

    async def connect(self):
        """Establish WebSocket connection"""
        try:
            self.websocket = await websockets.connect(self.uri)
            logging.info(
                f"{Colors.OKGREEN}âœ“ Connected to CHIMERA at {self.uri}{Colors.ENDC}")
            return True
        except Exception as e:
            logging.info(f"{Colors.FAIL}âœ— Connection failed: {e}{Colors.ENDC}")
            return False

    async def subscribe(self, event_type: str = "*"):
        """Subscribe to event stream"""
        if not self.websocket:
            logging.info(f"{Colors.FAIL}âœ— Not connected{Colors.ENDC}")
            return False

        # Send subscription request
        await self.websocket.send(json.dumps({
            "type": "subscribe_events",
            "client_id": self.client_id,
            "event_type": event_type
        }))

        # Wait for confirmation
        response = await self.websocket.recv()
        data = json.loads(response)

        if data.get("type") == "subscribed":
            logging.info(
                f"{Colors.OKGREEN}âœ“ Subscribed to events: {event_type}{Colors.ENDC}")
            logging.info(f"{Colors.OKCYAN}Client ID: {self.client_id}{Colors.ENDC}")
            logging.info(f"\n{Colors.BOLD}{'='*80}{Colors.ENDC}")
            logging.info(f"{Colors.BOLD}LIVE EVENT STREAM{Colors.ENDC}")
            logging.info(f"{Colors.BOLD}{'='*80}{Colors.ENDC}\n")
            return True
        else:
            logging.info(f"{Colors.FAIL}âœ— Subscription failed: {data}{Colors.ENDC}")
            return False

    def format_event(self, event: dict):
        """Format event for display"""
        event_type = event.get("type", "unknown")
        timestamp = datetime.fromtimestamp(event.get("timestamp", 0))
        data = event.get("data", {})
        priority = event.get("priority", 0)

        # Get color and icon
        color = self.event_colors.get(event_type, Colors.ENDC)
        icon = self.event_icons.get(event_type, "ðŸ“Œ")

        # Format timestamp
        time_str = timestamp.strftime("%H:%M:%S")

        # Build display string
        lines = []
        lines.append(
            f"{color}{icon} [{time_str}] {event_type.upper()}{Colors.ENDC}")

        # Add priority indicator if high priority
        if priority >= 7:
            lines.append(
                f"  {Colors.FAIL}Priority: {priority}/10{Colors.ENDC}")

        # Display event-specific data
        if event_type == "evolution_applied":
            topic = data.get("topic", "unknown")
            improvement = data.get("improvement", 0.0)
            fix = data.get("fix", "N/A")
            lines.append(f"  Topic: {topic}")
            lines.append(
                f"  Improvement: {Colors.OKGREEN}+{improvement:.4f}{Colors.ENDC}")
            lines.append(f"  Fix: {fix[:60]}...")

        elif event_type == "node_registered":
            node_id = data.get("node_id", "unknown")
            node_type = data.get("type", "worker")
            capabilities = data.get("capabilities", [])
            lines.append(f"  Node ID: {node_id[:16]}...")
            lines.append(f"  Type: {node_type}")
            lines.append(f"  Capabilities: {', '.join(capabilities)}")

        elif event_type == "tool_executed":
            tool = data.get("tool", "unknown")
            success = data.get("success", False)
            latency = data.get("latency", 0.0)
            status = f"{Colors.OKGREEN}SUCCESS{Colors.ENDC}" if success else f"{Colors.FAIL}FAILED{Colors.ENDC}"
            lines.append(f"  Tool: {tool}")
            lines.append(f"  Status: {status}")
            lines.append(f"  Latency: {latency:.4f}s")

        elif event_type == "confidence_changed":
            topic = data.get("topic", "unknown")
            old_conf = data.get("old_confidence", 0.0)
            new_conf = data.get("new_confidence", 0.0)
            delta = data.get("delta", 0.0)
            delta_str = f"{Colors.OKGREEN}+{delta:.4f}{Colors.ENDC}" if delta > 0 else f"{Colors.FAIL}{delta:.4f}{Colors.ENDC}"
            lines.append(f"  Topic: {topic}")
            lines.append(
                f"  Change: {old_conf:.4f} â†’ {new_conf:.4f} ({delta_str})")

        elif event_type == "task_dispatched" or event_type == "task_completed":
            tool = data.get("tool", "unknown")
            lines.append(f"  Tool: {tool}")
            if event_type == "task_completed":
                success = data.get("success", False)
                status = f"{Colors.OKGREEN}SUCCESS{Colors.ENDC}" if success else f"{Colors.FAIL}FAILED{Colors.ENDC}"
                lines.append(f"  Status: {status}")

        elif event_type == "system_alert":
            level = data.get("level", "info")
            message = data.get("message", "")
            lines.append(f"  Level: {level.upper()}")
            lines.append(f"  Message: {message}")

        else:
            # Generic data display
            for key, value in data.items():
                if isinstance(value, (str, int, float, bool)):
                    lines.append(f"  {key}: {value}")

        return "\n".join(lines)

    async def stream(self):
        """Listen for events and display them"""
        if not self.websocket:
            return

        try:
            async for message in self.websocket:
                data = json.loads(message)

                if data.get("type") == "event":
                    event = data.get("event", {})
                    logging.info(self.format_event(event))
                    logging.info(f"{Colors.BOLD}{'-'*80}{Colors.ENDC}\n")

        except websockets.exceptions.ConnectionClosed:
            logging.info(f"\n{Colors.WARNING}Connection closed by server{Colors.ENDC}")
        except KeyboardInterrupt:
            logging.info(f"\n{Colors.WARNING}Stopping event stream...{Colors.ENDC}")

    async def run(self, event_type: str = "*"):
        """Main run loop"""
        if await self.connect():
            if await self.subscribe(event_type):
                await self.stream()

            # Cleanup
            if self.websocket:
                await self.websocket.close()


async def main():
    parser = argparse.ArgumentParser(
        description="CHIMERA Event Stream Monitor")
    parser.add_argument("--host", default="localhost",
                        help="CHIMERA host (default: localhost)")
    parser.add_argument("--port", type=int, default=3001,
                        help="WebSocket port (default: 3001)")
    parser.add_argument("--ssl", action="store_true", help="Use SSL (wss://)")
    parser.add_argument("--event-type", default="*",
                        help="Event type to subscribe to (* for all)")

    args = parser.parse_args()

    # Print header
    logging.info(f"\n{Colors.BOLD}{Colors.HEADER}{'='*80}{Colors.ENDC}")
    logging.info(f"{Colors.BOLD}{Colors.HEADER}CHIMERA AUTARCH - Event Stream Monitor v1.0{Colors.ENDC}")
    logging.info(f"{Colors.BOLD}{Colors.HEADER}{'='*80}{Colors.ENDC}\n")

    client = EventStreamClient(
        host=args.host, port=args.port, use_ssl=args.ssl)
    await client.run(event_type=args.event_type)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logging.info(f"\n{Colors.OKGREEN}âœ“ Goodbye!{Colors.ENDC}\n")
