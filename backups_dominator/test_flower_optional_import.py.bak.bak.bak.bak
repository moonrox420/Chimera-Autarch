#!/usr/bin/env python3
"""
Test script to verify Flower optional import implementation
Tests both with and without Flower installed
"""

import logging
import sys
import os

# Set up logging to see the import status
logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')

# Test the federated learning module
print("=" * 60)
print("ğŸ§ª TESTING FLOWER OPTIONAL IMPORT IMPLEMENTATION")
print("=" * 60)

# Import our federated learning module
try:
    from federated_learning import FLOWER_AVAILABLE, FlowerIntegration, get_flower_status
    print("âœ… Successfully imported federated_learning module")
except ImportError as e:
    print(f"âŒ Failed to import federated_learning module: {e}")
    sys.exit(1)

# Test 1: Check FLOWER_AVAILABLE flag
print(f"\nğŸ“Š Test 1: FLOWER_AVAILABLE flag")
print(f"   Result: {FLOWER_AVAILABLE}")
print(f"   Expected: False (Flower not installed)")
print(f"   Status: {'âœ… PASS' if not FLOWER_AVAILABLE else 'âŒ FAIL'}")

# Test 2: Check status function
print(f"\nğŸ“Š Test 2: get_flower_status() function")
status = get_flower_status()
print(f"   Result: {status}")
expected_available = FLOWER_AVAILABLE
print(f"   Expected flower_available: {expected_available}")
print(f"   Status: {'âœ… PASS' if status['flower_available'] == expected_available else 'âŒ FAIL'}")

# Test 3: Test FlowerIntegration class
print(f"\nğŸ“Š Test 3: FlowerIntegration initialization")
try:
    integration = FlowerIntegration()
    available = integration.is_flower_available()
    print(f"   FlowerIntegration created successfully")
    print(f"   is_flower_available(): {available}")
    print(f"   Expected: {FLOWER_AVAILABLE}")
    print(f"   Status: {'âœ… PASS' if available == FLOWER_AVAILABLE else 'âŒ FAIL'}")
except Exception as e:
    print(f"   âŒ FAIL: {e}")

# Test 4: Test strategy creation
print(f"\nğŸ“Š Test 4: Strategy creation")
try:
    integration = FlowerIntegration()
    strategy = integration.create_strategy()
    print(f"   Strategy created: {type(strategy).__name__}")
    print(f"   Status: âœ… PASS")
except Exception as e:
    print(f"   âŒ FAIL: {e}")

# Test 5: Test server config creation
print(f"\nğŸ“Š Test 5: Server config creation")
try:
    integration = FlowerIntegration()
    config = integration.create_server_config(num_rounds=5)
    print(f"   Config created: {type(config).__name__}")
    if hasattr(config, 'num_rounds'):
        print(f"   num_rounds: {config.num_rounds}")
    print(f"   Status: âœ… PASS")
except Exception as e:
    print(f"   âŒ FAIL: {e}")

# Test 6: Verify mock implementations exist
print(f"\nğŸ“Š Test 6: Mock implementations availability")
if not FLOWER_AVAILABLE:
    try:
        from federated_learning import ServerConfig, FedAvg
        mock_config = ServerConfig(num_rounds=3)
        mock_strategy = FedAvg(min_fit_clients=2)
        print(f"   Mock implementations available")
        print(f"   MockServerConfig created with num_rounds: {mock_config.num_rounds}")
        print(f"   MockFedAvg created with config: {mock_strategy.config}")
        print(f"   Status: âœ… PASS")
    except Exception as e:
        print(f"   âŒ FAIL: {e}")
else:
    print(f"   Flower is available - no mock implementations needed")
    print(f"   Status: âœ… PASS")

print("\n" + "=" * 60)
print("ğŸ TEST SUMMARY")
print("=" * 60)

if FLOWER_AVAILABLE:
    print("ğŸŒ¸ Flower framework is installed and working")
    print("ğŸ“¦ Real Flower components are being used")
else:
    print("ğŸ­ Flower framework is not installed")
    print("ğŸ“¦ Mock implementations are being used as fallback")
    print("ğŸ’¡ To enable real federated learning, install Flower:")
    print("   pip install flwr")

print("\nâœ¨ Optional import pattern implemented successfully!")
print("âœ… Graceful fallback works correctly")
print("âœ… No hard dependencies on Flower")
print("âœ… Runtime availability checking works")

# Demonstrate the exact pattern requested
print("\n" + "=" * 60)
print("ğŸ“‹ IMPLEMENTED PATTERN (as requested)")
print("=" * 60)
print("""
try:
    import flwr as fl
    from flwr.server import ServerConfig
    from flwr.server.strategy import FedAvg
    FLOWER_AVAILABLE = True
except ImportError:
    # Handle case when Flower is not available
    FLOWER_AVAILABLE = False
""")

print("âœ… This exact pattern has been implemented in federated_learning.py")
