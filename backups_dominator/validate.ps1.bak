#!/usr/bin/env pwsh
<#
.SYNOPSIS
    Validate CHIMERA AUTARCH installation and configuration

.DESCRIPTION
    Comprehensive validation of environment, dependencies, and system readiness
#>

$ErrorActionPreference = "Continue"

function Write-Status {
  param([string]$Message, [string]$Status)
  $Color = switch ($Status) {
    "OK" { "Green" }
    "WARN" { "Yellow" }
    "FAIL" { "Red" }
    "INFO" { "Cyan" }
  }
  Write-Host "[$Status] " -NoNewline -ForegroundColor $Color
  Write-Host $Message
}

Write-Host ""
Write-Host "üîç CHIMERA AUTARCH System Validation" -ForegroundColor Cyan
Write-Host "=====================================" -ForegroundColor Cyan
Write-Host ""

$Issues = 0
$Warnings = 0

# Check Python version
Write-Host "üêç Python Environment" -ForegroundColor Yellow
Write-Host "---------------------" -ForegroundColor Yellow
$PythonVersion = python --version 2>&1
if ($LASTEXITCODE -eq 0) {
  if ($PythonVersion -match "Python 3\.1[2-9]") {
    Write-Status "Python version: $PythonVersion" "OK"
  }
  else {
    Write-Status "Python version: $PythonVersion (3.12+ recommended)" "WARN"
    $Warnings++
  }
}
else {
  Write-Status "Python not found in PATH" "FAIL"
  $Issues++
}

# Check virtual environment
$VenvPath = "droxai-env"
if (Test-Path $VenvPath) {
  Write-Status "Virtual environment exists: $VenvPath" "OK"
    
  # Check if activated
  if ($env:VIRTUAL_ENV) {
    Write-Status "Virtual environment is activated" "OK"
  }
  else {
    Write-Status "Virtual environment not activated (run: .\droxai-env\Scripts\Activate.ps1)" "INFO"
  }
}
else {
  Write-Status "Virtual environment not found" "WARN"
  $Warnings++
}

Write-Host ""

# Check required files
Write-Host "üìÅ Project Files" -ForegroundColor Yellow
Write-Host "----------------" -ForegroundColor Yellow

$RequiredFiles = @(
  "chimera_autarch.py",
  "ws_client.py",
  "config.py",
  "requirements.txt",
  "README.md",
  ".gitignore"
)

foreach ($File in $RequiredFiles) {
  if (Test-Path $File) {
    Write-Status "$File exists" "OK"
  }
  else {
    Write-Status "$File missing" "FAIL"
    $Issues++
  }
}

# Check optional files
$OptionalFiles = @(
  "config.yaml",
  "config.example.yaml",
  ".env",
  "cert.pem",
  "key.pem"
)

foreach ($File in $OptionalFiles) {
  if (Test-Path $File) {
    Write-Status "$File exists (optional)" "OK"
  }
  else {
    Write-Status "$File not found (optional)" "INFO"
  }
}

Write-Host ""

# Check dependencies
Write-Host "üì¶ Dependencies" -ForegroundColor Yellow
Write-Host "---------------" -ForegroundColor Yellow

$RequiredPackages = @(
  "websockets",
  "aiosqlite",
  "numpy",
  "pyyaml"
)

$OptionalPackages = @(
  "flwr",
  "grpcio"
)

$TestPackages = @(
  "pytest",
  "pytest-asyncio",
  "pytest-cov"
)

Write-Host "Required packages:" -ForegroundColor Cyan
foreach ($Package in $RequiredPackages) {
  $Installed = pip show $Package 2>$null
  if ($Installed) {
    $Version = ($Installed | Select-String "Version:").ToString().Split(":")[1].Trim()
    Write-Status "$Package ($Version)" "OK"
  }
  else {
    Write-Status "$Package not installed" "FAIL"
    $Issues++
  }
}

Write-Host ""
Write-Host "Optional packages:" -ForegroundColor Cyan
foreach ($Package in $OptionalPackages) {
  $Installed = pip show $Package 2>$null
  if ($Installed) {
    $Version = ($Installed | Select-String "Version:").ToString().Split(":")[1].Trim()
    Write-Status "$Package ($Version)" "OK"
  }
  else {
    Write-Status "$Package not installed (federated learning disabled)" "INFO"
  }
}

Write-Host ""
Write-Host "Test packages:" -ForegroundColor Cyan
foreach ($Package in $TestPackages) {
  $Installed = pip show $Package 2>$null
  if ($Installed) {
    $Version = ($Installed | Select-String "Version:").ToString().Split(":")[1].Trim()
    Write-Status "$Package ($Version)" "OK"
  }
  else {
    Write-Status "$Package not installed (run: pip install pytest pytest-asyncio pytest-cov)" "INFO"
  }
}

Write-Host ""

# Check syntax
Write-Host "üîß Syntax Validation" -ForegroundColor Yellow
Write-Host "---------------------" -ForegroundColor Yellow

$PythonFiles = @("chimera_autarch.py", "config.py", "ws_client.py")
foreach ($File in $PythonFiles) {
  if (Test-Path $File) {
    python -m py_compile $File 2>$null
    if ($LASTEXITCODE -eq 0) {
      Write-Status "$File syntax valid" "OK"
    }
    else {
      Write-Status "$File has syntax errors" "FAIL"
      $Issues++
    }
  }
}

Write-Host ""

# Check ports
Write-Host "üåê Port Availability" -ForegroundColor Yellow
Write-Host "---------------------" -ForegroundColor Yellow

$Ports = @(3001, 3000, 8080)
foreach ($Port in $Ports) {
  $Connection = Get-NetTCPConnection -LocalPort $Port -ErrorAction SilentlyContinue
  if ($Connection) {
    Write-Status "Port $Port is in use (may conflict)" "WARN"
    $Warnings++
  }
  else {
    Write-Status "Port $Port is available" "OK"
  }
}

Write-Host ""

# Check Docker (if available)
Write-Host "üê≥ Docker Support" -ForegroundColor Yellow
Write-Host "-----------------" -ForegroundColor Yellow

$DockerInstalled = Get-Command docker -ErrorAction SilentlyContinue
if ($DockerInstalled) {
  Write-Status "Docker is installed" "OK"
    
  if (Test-Path "Dockerfile") {
    Write-Status "Dockerfile exists" "OK"
  }
    
  if (Test-Path "docker-compose.yml") {
    Write-Status "docker-compose.yml exists" "OK"
  }
}
else {
  Write-Status "Docker not found (optional for containerized deployment)" "INFO"
}

Write-Host ""

# Check database
Write-Host "üíæ Persistence" -ForegroundColor Yellow
Write-Host "--------------" -ForegroundColor Yellow

if (Test-Path "chimera_memory.db") {
  $DbSize = (Get-Item "chimera_memory.db").Length
  Write-Status "Database exists ($([Math]::Round($DbSize/1KB, 2)) KB)" "OK"
}
else {
  Write-Status "Database not yet created (will be created on first run)" "INFO"
}

if (Test-Path "backups") {
  $BackupCount = (Get-ChildItem "backups" -Filter "*.db" -ErrorAction SilentlyContinue).Count
  Write-Status "Backup directory exists ($BackupCount backups)" "OK"
}
else {
  Write-Status "Backup directory will be created on first run" "INFO"
}

Write-Host ""

# Summary
Write-Host "üìä Validation Summary" -ForegroundColor Cyan
Write-Host "=====================" -ForegroundColor Cyan
Write-Host ""

if ($Issues -eq 0 -and $Warnings -eq 0) {
  Write-Host "‚úÖ All checks passed! System is ready." -ForegroundColor Green
  Write-Host ""
  Write-Host "Next steps:" -ForegroundColor Cyan
  Write-Host "  1. Start the system: .\start.ps1" -ForegroundColor White
  Write-Host "  2. Run tests: .\run_tests.ps1" -ForegroundColor White
  Write-Host "  3. Open dashboard: http://0.0.0.0:3000" -ForegroundColor White
  exit 0
}
elseif ($Issues -eq 0) {
  Write-Host "‚ö†Ô∏è  $Warnings warning(s) found, but system should work." -ForegroundColor Yellow
  Write-Host ""
  Write-Host "You can proceed with:" -ForegroundColor Cyan
  Write-Host "  .\start.ps1" -ForegroundColor White
  exit 0
}
else {
  Write-Host "‚ùå $Issues critical issue(s) found, $Warnings warning(s)." -ForegroundColor Red
  Write-Host ""
  Write-Host "Please fix the issues above before starting the system." -ForegroundColor Yellow
  Write-Host ""
  Write-Host "Common fixes:" -ForegroundColor Cyan
  Write-Host "  ‚Ä¢ Install Python 3.12+: https://www.python.org/downloads/" -ForegroundColor White
  Write-Host "  ‚Ä¢ Create virtual environment: python -m venv droxai-env" -ForegroundColor White
  Write-Host "  ‚Ä¢ Install dependencies: pip install -r requirements.txt" -ForegroundColor White
  exit 1
}
