#!/usr/bin/env python3
import os
import sys
import time
import subprocess
import webbrowser
from pathlib import Path

# --- NEW LOGIC: Determine Project Root ---
LAUNCHER_HOME = Path(sys.executable).parent if getattr(sys, "frozen", False) else Path(__file__).parent
PROJECT_ROOT = LAUNCHER_HOME.parent if LAUNCHER_HOME.name == 'build' else LAUNCHER_HOME

# --- Path Setup: Crucial for module discovery ---
sys.path.append(str(PROJECT_ROOT))
os.environ['PYTHONPATH'] = str(PROJECT_ROOT) + os.pathsep + os.environ.get('PYTHONPATH', '')

# Import the Configuration Manager (now accessible via sys.path modification)
try:
    from DroxAI_ConfigManager import ConfigManager
except ImportError as e:
    logging.info(f"FATAL: Cannot find DroxAI_ConfigManager.py. Searched in: {PROJECT_ROOT}. Error: {e}")
    sys.exit(1)

# --- Configuration Loading ---
config = ConfigManager.load_config()

# --- Environment Setup (Passing resolved config values to OS Environment) ---
os.environ["HTTP_HOST"] = config.server.http_host
os.environ["HTTP_PORT"] = str(config.server.http_port)
os.environ["WS_HOST"] = config.server.websocket_host
os.environ["WS_PORT"] = str(config.server.websocket_port)

# --- Backend Search Priority (CRITICAL FIX) ---
# We prioritize the newest, most integrated file first.
BACKEND_PRIORITY = [
    "chimera_autarch_v4_tuned.py", # <-- HIGHEST PRIORITY NOW
    "DroxAI_Core.py",
    "chimera_autarch_final.py",
    "chimera_autarch.py",
    "main.py",
    "app.py"
]

# Search for the backend file in the calculated PROJECT_ROOT
backend = next((PROJECT_ROOT / f for f in BACKEND_PRIORITY if (PROJECT_ROOT / f).exists()), None)

if not backend:
    logging.info("FATAL: No backend found. Expected one of:")
    for f in BACKEND_PRIORITY:
        logging.info(f"  - {f}")
    input("Press Enter to exit...")
    sys.exit(1)

logging.info(f"[{config.app.name}] Launching backend → {backend.name}")
logging.info(f"[{config.app.name}] Binding {config.server.http_host}:{config.server.http_port} (HTTP) / {config.server.websocket_host}:{config.server.websocket_port} (WS)")

# EXECUTION 
proc = subprocess.Popen(
    [sys.executable, str(backend)],
    cwd=str(PROJECT_ROOT), 
    env=os.environ
)

time.sleep(4)

if proc.poll() is None:
    # CRITICAL DASHBOARD URL FIX
    dashboard_url = f"http://0.0.0.0:{config.server.http_port}/chimera_god_cli.html" 
    logging.info(f"[{config.app.name}] FORTRESS LIVE → {dashboard_url}")
    webbrowser.open(dashboard_url)
else:
    logging.info(f"[{config.app.name}] Backend crashed on startup (Exit Code: {proc.poll()}). Check console output above for tracebacks.")
    input("Press Enter to exit...")
    sys.exit(1)

try:
    proc.wait()
except KeyboardInterrupt:
    logging.info(f"\n[{config.app.name}] Shutting down fortress...")
    proc.terminate()

logging.info(f"[{config.app.name}] Fortress offline.")