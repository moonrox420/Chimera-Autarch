#!/usr/bin/env python3
"""Quick test script for Qwen 2.5 Coder integration with CHIMERA"""

import asyncio
import sys
from pathlib import Path


async def test_qwen_model():
    """Test if Qwen 2.5 Coder is available and working"""

    logging.info("=" * 60)
    logging.info("QWEN 2.5 CODER - Quick Test")
    logging.info("=" * 60)

    # Test 1: Check if llm_integration module exists
    logging.info("\nüì¶ Test 1: Checking llm_integration module...")
    try:
        sys.path.insert(0, str(Path(__file__).parent))
        from llm_integration import CodeGenerator
        logging.info("‚úÖ llm_integration module loaded")
    except Exception as e:
        logging.info(f"‚ùå Failed to load module: {e}")
        return False

    # Test 2: Initialize generator
    logging.info("\nüîß Test 2: Initializing Code Generator...")
    try:
        generator = CodeGenerator()
        logging.info(f"‚úÖ Generator initialized")
        logging.info(f"   Provider: {generator.provider.__class__.__name__}")
        if hasattr(generator.provider, 'model'):
            logging.info(f"   Model: {generator.provider.model}")
    except Exception as e:
        logging.info(f"‚ùå Failed to initialize: {e}")
        return False

    # Test 3: Check Ollama availability
    logging.info("\nü§ñ Test 3: Checking Ollama models...")
    try:
        import httpx
        async with httpx.AsyncClient(timeout=5.0) as client:
            response = await client.get("http://localhost: 3000/api/tags")
            if response.status_code == 200:
                models = response.json().get("models", [])
                logging.info(f"‚úÖ Ollama server running")
                logging.info(f"   Available models: {len(models)}")
                for model in models:
                    name = model.get("name", "unknown")
                    size = model.get("size", 0) / (1024**3)  # Convert to GB
                    logging.info(f"   - {name} ({size:.1f} GB)")

                # Check for Qwen specifically
                qwen_found = any("qwen" in m.get("name", "").lower()
                                 for m in models)
                if qwen_found:
                    logging.info("\n‚úÖ Qwen 2.5 Coder is ready!")
                else:
                    logging.info("\n‚ö†Ô∏è  Qwen 2.5 Coder not found yet")
                    logging.info("   Model may still be downloading...")
                    logging.info("   Check with: ollama list")
            else:
                logging.info(
                    f"‚ùå Ollama server returned status {response.status_code}")
                return False
    except Exception as e:
        logging.info(f"‚ùå Failed to connect to Ollama: {e}")
        logging.info("   Make sure Ollama is running: ollama serve")
        return False

    # Test 4: Simple code generation (only if model ready)
    if qwen_found:
        logging.info("\nüöÄ Test 4: Testing code generation...")
        try:
            code = await generator.generate_code(
                "Create a Python function that calculates fibonacci numbers",
                context="Simple utility function"
            )
            logging.info("‚úÖ Code generation successful!")
            logging.info(f"\nGenerated code preview (first 200 chars):")
            logging.info("-" * 60)
            logging.info(code[:200] + "..." if len(code) > 200 else code)
            logging.info("-" * 60)
        except Exception as e:
            logging.info(f"‚ùå Code generation failed: {e}")
            return False

    logging.info("\n" + "=" * 60)
    if qwen_found:
        logging.info("‚úÖ ALL TESTS PASSED - Qwen 2.5 Coder is ready!")
        logging.info("\nüöÄ Next steps:")
        logging.info("   1. Run: python test_llm.py")
        logging.info("   2. Run: python chimera_autarch.py")
        logging.info("   3. Visit: http://localhost: 3000")
    else:
        logging.info("‚è≥ Setup incomplete - waiting for model download")
        logging.info("\nüìù To check download progress:")
        logging.info("   Run: ollama list")
        logging.info("\nüìù Once complete, run this test again:")
        logging.info("   python quick_test.py")
    logging.info("=" * 60)

    return qwen_found


if __name__ == "__main__":
    success = asyncio.run(test_qwen_model())
    sys.exit(0 if success else 1)
